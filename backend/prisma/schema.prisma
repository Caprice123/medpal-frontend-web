generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model constants {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  @@index([key])
}

model credit_plans {
  id                  Int                   @id @default(autoincrement())
  name                String
  description         String?
  credits             Int
  price               Decimal               @db.Decimal(10, 2)
  isActive            Boolean               @default(true)
  isPopular           Boolean               @default(false)
  discount            Int                   @default(0)
  order               Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  credit_transactions credit_transactions[]
}

model credit_transactions {
  id               Int           @id @default(autoincrement())
  userId           Int
  userCreditId     Int
  type             String
  amount           Int
  balanceBefore    Int
  balanceAfter     Int
  description      String?
  creditPlanId     Int?
  sessionId        Int?
  paymentStatus    String?
  paymentMethod    String?
  paymentReference String?
  createdAt        DateTime      @default(now())
  credit_plans     credit_plans? @relation(fields: [creditPlanId], references: [id])
  user_credits     user_credits  @relation(fields: [userCreditId], references: [id])

  @@index([paymentStatus])
  @@index([type])
  @@index([userCreditId])
  @@index([userId])
}

model exercise_questions {
  id              Int             @id @default(autoincrement())
  topic_id        Int
  question        String
  answer          String
  explanation     String
  order           Int             @default(0)
  created_at      DateTime        @default(now())
  updated_at      DateTime        @default(now())
  exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@index([order])
  @@index([topic_id])
}

model exercise_session_answers {
  id                           Int                          @id @default(autoincrement())
  exercise_session_id          Int
  exercise_session_question_id Int
  user_answer                  String
  is_correct                   Boolean
  answered_at                  DateTime                     @default(now())
  time_taken_seconds           Int?
  exercise_sessions            exercise_sessions            @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)
  exercise_session_questions   exercise_session_questions   @relation(fields: [exercise_session_question_id], references: [id], onDelete: Cascade)

  @@index([answered_at])
  @@index([exercise_session_id])
  @@index([exercise_session_question_id])
}

model exercise_sessions {
  id                          Int                           @id @default(autoincrement())
  user_learning_session_id    Int
  user_id                     Int
  exercise_topic_id           Int?
  topic_snapshot              String?
  credits_used                Int                           @default(0)
  started_at                  DateTime                      @default(now())
  completed_at                DateTime?
  status                      String                        @default("not_started")
  score                       Int                           @default(0)
  total_questions             Int                           @default(0)
  exercise_session_answers    exercise_session_answers[]
  exercise_session_questions  exercise_session_questions[]
  exercise_topics             exercise_topics?              @relation(fields: [exercise_topic_id], references: [id])
  user_learning_sessions      user_learning_sessions        @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)

  @@index([exercise_topic_id])
  @@index([started_at])
  @@index([status])
  @@index([user_id])
  @@index([user_learning_session_id])
}

model exercise_session_questions {
  id                       Int                        @id @default(autoincrement())
  exercise_session_id      Int
  question_id              Int
  question_text            String
  answer_text              String
  explanation              String
  order                    Int
  created_at               DateTime                   @default(now())
  exercise_sessions        exercise_sessions          @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)
  exercise_session_answers exercise_session_answers[]

  @@index([exercise_session_id])
  @@index([order])
}

model exercise_topic_tags {
  id              Int             @id @default(autoincrement())
  topic_id        Int
  tag_id          Int
  created_at      DateTime        @default(now())
  tags            tags            @relation(fields: [tag_id], references: [id], onDelete: Cascade)
  exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@unique([topic_id, tag_id])
  @@index([tag_id])
  @@index([topic_id])
}

model exercise_topics {
  id                  Int                   @id @default(autoincrement())
  title               String
  description         String?
  content_type        String
  content             String?
  pdf_url             String?
  pdf_key             String?
  pdf_filename        String?
  status              String                @default("draft")
  is_active           Boolean               @default(true)
  created_by          Int
  created_at          DateTime              @default(now())
  updated_at          DateTime              @default(now())
  exercise_questions  exercise_questions[]
  exercise_sessions   exercise_sessions[]
  exercise_topic_tags exercise_topic_tags[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model features {
  id          Int        @id @default(autoincrement())
  name        String
  description String @db.Text
  icon        String @db.Text
  cost        Int 
  isActive    Boolean @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  sessions    sessions[]
  topics      topics[]
}

model queries {
  id        Int      @id @default(autoincrement())
  question  String
  answer    String?
  userId    Int
  createdAt DateTime @default(now())
}

model sessions {
  id          Int       @id @default(autoincrement())
  userId      Int
  featureId   Int
  topicId     Int?
  creditsUsed Int
  status      String    @default("active")
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  features    features  @relation(fields: [featureId], references: [id])
  topics      topics?   @relation(fields: [topicId], references: [id])

  @@index([featureId])
  @@index([topicId])
  @@index([userId])
}

model tags {
  id                  Int                   @id @default(autoincrement())
  name                String
  type                String
  is_active           Boolean               @default(true)
  created_at          DateTime              @default(now())
  updated_at          DateTime              @default(now())
  exercise_topic_tags exercise_topic_tags[]

  @@unique([name, type])
  @@index([is_active])
  @@index([type])
}

model topics {
  id          Int        @id @default(autoincrement())
  featureId   Int
  title       String
  description String?
  content     String?
  isActive    Boolean    @default(true)
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  sessions    sessions[]
  features    features   @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@index([featureId])
}

model user_credits {
  id                  Int                   @id @default(autoincrement())
  userId              Int                   @unique
  balance             Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  credit_transactions credit_transactions[]

  @@index([userId])
}

model user_learning_sessions {
  id                Int                 @id @default(autoincrement())
  user_id           Int
  type              String              @default("exercise")
  started_at        DateTime            @default(now())
  ended_at          DateTime?
  status            String              @default("active")
  exercise_sessions exercise_sessions[]

  @@index([started_at])
  @@index([status])
  @@index([type])
  @@index([user_id])
}

model user_sessions {
  id           Int      @id @default(autoincrement())
  userId       Int
  token        String   @unique
  isActive     Boolean  @default(true)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model users {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  picture   String?
  googleId  String?  @unique
  role      String   @default("user")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}
